// Calendar data for 2025
const calendarData = {
  months: [
    {
      name: "Janeiro",
      days: [
        { date: 1, events: [{ type: "feriado", text: "Ano Novo" }] },
        { date: 2, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 3, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 4, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 5, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 6, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 7, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 8, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 9, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 10, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 11, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 12, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 13, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 14, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 15, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 16, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 17, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 18, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 19, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 20, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 21, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 22, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 23, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 24, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 25, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 26, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 27, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 28, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 29, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 30, events: [{ type: "ferias", text: "Férias Escolares" }] },
        { date: 31, events: [{ type: "ferias", text: "Férias Escolares" }] },
      ],
    },
    {
      name: "Fevereiro",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        {
          date: 3,
          events: [{ type: "pedagogica", text: "Semana Pedagógica" }],
        },
        {
          date: 4,
          events: [{ type: "pedagogica", text: "Semana Pedagógica" }],
        },
        {
          date: 5,
          events: [{ type: "pedagogica", text: "Semana Pedagógica" }],
        },
        {
          date: 6,
          events: [{ type: "pedagogica", text: "Semana Pedagógica" }],
        },
        {
          date: 7,
          events: [{ type: "pedagogica", text: "Semana Pedagógica" }],
        },
        { date: 8, events: [{ type: "reuniao", text: "Reunião de Pais" }] },
        { date: 9, events: [] },
        { date: 10, events: [{ type: "inicio", text: "Início das Aulas" }] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
      ],
    },
    {
      name: "Março",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [{ type: "feriado", text: "Feriado/Carnaval" }] },
        { date: 4, events: [{ type: "feriado", text: "Feriado/Carnaval" }] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        {
          date: 26,
          events: [{ type: "feriado", text: "Feriado/Emancipação Barueri" }],
        },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
        { date: 31, events: [] },
      ],
    },
    {
      name: "Abril",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [{ type: "feriado", text: "Endoenças" }] },
        { date: 18, events: [{ type: "feriado", text: "Sexta-feira Santa" }] },
        { date: 19, events: [] },
        { date: 20, events: [{ type: "feriado", text: "Páscoa" }] },
        { date: 21, events: [{ type: "feriado", text: "Tiradentes" }] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
      ],
    },
    {
      name: "Maio",
      days: [
        { date: 1, events: [{ type: "feriado", text: "Dia do Trabalho" }] },
        {
          date: 2,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 9, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
        { date: 31, events: [] },
      ],
    },
    {
      name: "Junho",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [{ type: "evento", text: "Festa Junina" }] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [{ type: "feriado", text: "Corpus Christi" }] },
        {
          date: 20,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        { date: 21, events: [] },
        { date: 22, events: [] },
        {
          date: 23,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        {
          date: 24,
          events: [{ type: "feriado", text: "Padroeiro São João Batista" }],
        },
        { date: 25, events: [] },
        { date: 26, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 27, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 29, events: [] },
        { date: 30, events: [] },
      ],
    },
    {
      name: "Julho",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [{ type: "reuniao", text: "Reunião de Pais" }] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 8, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 9, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 10, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 11, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 12, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 13, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 14, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 15, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 16, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 17, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 18, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 19, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 20, events: [{ type: "ferias", text: "Recesso Escolar" }] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
        { date: 31, events: [] },
      ],
    },
    {
      name: "Agosto",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
        { date: 31, events: [] },
      ],
    },
    {
      name: "Setembro",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [{ type: "evento", text: "Civico Militar" }] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 26, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
      ],
    },
    {
      name: "Outubro",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [{ type: "reuniao", text: "Reunião de Pais" }] },
        { date: 5, events: [] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 12, events: [] },
        { date: 11, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        {
          date: 15,
          events: [{ type: "Dia sem Expediente", text: "Dia do Professor" }],
        },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        {
          date: 27,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        {
          date: 28,
          events: [{ type: "feriado", text: "Funcionário Publico" }],
        },
        { date: 29, events: [] },
        { date: 30, events: [] },
        { date: 31, events: [] },
      ],
    },
    {
      name: "Novembro",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [] },
        { date: 5, events: [] },
        { date: 6, events: [{ type: "reuniao", text: "Reunião de Pais" }] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        {
          date: 15,
          events: [{ type: "feriado", text: "Proclamação da República" }],
        },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [{ type: "feriado", text: "Consciencia Negra" }] },
        {
          date: 21,
          events: [{ type: "feriado", text: "Nossa Senhora da Escada" }],
        },
        { date: 22, events: [] },
        { date: 23, events: [] },
        { date: 24, events: [] },
        { date: 25, events: [] },
        { date: 26, events: [] },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
      ],
    },
    {
      name: "Dezembro",
      days: [
        { date: 1, events: [] },
        { date: 2, events: [] },
        { date: 3, events: [] },
        { date: 4, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 5, events: [{ type: "evento", text: "Conselho de Classe" }] },
        { date: 6, events: [] },
        { date: 7, events: [] },
        { date: 8, events: [] },
        { date: 9, events: [] },
        { date: 10, events: [] },
        { date: 11, events: [] },
        { date: 12, events: [] },
        { date: 13, events: [] },
        { date: 14, events: [] },
        { date: 15, events: [] },
        { date: 16, events: [] },
        { date: 17, events: [] },
        { date: 18, events: [] },
        { date: 19, events: [] },
        { date: 20, events: [] },
        { date: 21, events: [] },
        { date: 22, events: [] },
        { date: 23, events: [] },
        {
          date: 24,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        { date: 25, events: [] },
        {
          date: 26,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
        { date: 27, events: [] },
        { date: 28, events: [] },
        { date: 29, events: [] },
        { date: 30, events: [] },
        {
          date: 31,
          events: [{ type: "Dia sem Expediente", text: "Dia sem Expediente" }],
        },
      ],
    },
  ],
};

// Function to create a calendar month
function createMonthCalendar(monthData, monthIndex) {
  const monthDiv = document.createElement("div");
  monthDiv.className = "calendar-month bg-white p-3 rounded-lg shadow-md mb-4";

  const monthHeader = document.createElement("h3");
  monthHeader.textContent = monthData.name;
  monthHeader.className = "text-lg font-bold mb-3 text-center";
  monthDiv.appendChild(monthHeader);

  const daysGrid = document.createElement("div");
  daysGrid.className = "grid grid-cols-7 gap-0.5 text-center text-xs";

  // Add weekday headers
  const weekdays = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
  weekdays.forEach((day) => {
    const dayHeader = document.createElement("div");
    dayHeader.textContent = day;
    dayHeader.className = "font-bold p-1 bg-gray-200 text-xs";
    daysGrid.appendChild(dayHeader);
  });

  // Descobrir o primeiro dia da semana do mês
  const firstDate = new Date(2025, monthIndex, 1);
  const firstWeekDay = firstDate.getDay(); // 0 = domingo, 1 = segunda, ...

  // Adicionar células vazias antes do dia 1
  for (let i = 0; i < firstWeekDay; i++) {
    const emptyDiv = document.createElement("div");
    emptyDiv.className = "p-1";
    daysGrid.appendChild(emptyDiv);
  }

  // Add days
  monthData.days.forEach((day) => {
    const dayDiv = document.createElement("div");
    dayDiv.textContent = day.date;
    dayDiv.className = "p-1 border min-h-[35px] relative text-xs";

    const date = new Date(2025, monthIndex, day.date);
    const weekDay = date.getDay();

    // Dias de Conselho de Classe
    if (
      (monthData.name === "Maio" && (day.date === 8 || day.date === 9)) ||
      (monthData.name === "Junho" && (day.date === 26 || day.date === 27)) ||
      (monthData.name === "Setembro" && (day.date === 25 || day.date === 26)) ||
      (monthData.name === "Dezembro" && (day.date === 4 || day.date === 5))
    ) {
      dayDiv.style.backgroundColor = "#8ff5aa";
      dayDiv.title = "Conselho de Classe";
    }
    // Dia 02 de maio: dia sem expediente
    else if (monthData.name === "Maio" && day.date === 2) {
      dayDiv.style.backgroundColor = "#ff00ff";
      dayDiv.title = "Dia sem expediente";
    }
    // Aplicar cores baseadas nos eventos
    else if (day.events.length > 0) {
      const event = day.events[0];

      switch (event.type) {
        case "feriado":
          dayDiv.style.backgroundColor = "#ff0000";
          dayDiv.style.color = "#fff";
          break;
        case "ferias":
          dayDiv.style.backgroundColor = "#ff7878";
          break;
        case "pedagogica":
          dayDiv.style.backgroundColor = "#FFD700";
          break;
        case "reuniao":
          dayDiv.style.backgroundColor = "#7955FA";
          dayDiv.style.color = "#fff";
          break;
        case "inicio":
          dayDiv.style.backgroundColor = "#ffffff";
          dayDiv.style.border = "2px solid #000";
          break;
        case "evento":
          dayDiv.style.backgroundColor = "#edf574";
          break;
        case "Dia sem Expediente":
          dayDiv.style.backgroundColor = "#ff00ff";
          dayDiv.title = "Dia sem expediente";
          break;
        default:
          // Dias letivos normais
          dayDiv.style.backgroundColor = "#87CEEB";
      }
      // Adicionar tooltip com informações do evento
      dayDiv.title = event.text;
    } else {
      // Sábados e domingos
      if (weekDay === 0 || weekDay === 6) {
        dayDiv.style.backgroundColor = "#ff0000";
        dayDiv.style.color = "#fff";
      } else {
        // Dias letivos normais
        dayDiv.style.backgroundColor = "#87CEEB";
      }
    }

    daysGrid.appendChild(dayDiv);
  });

  monthDiv.appendChild(daysGrid);
  return monthDiv;
}

// Initialize calendar
function initializeCalendar() {
  const container = document.getElementById("calendarContainer");

  // Remove meses antigos se houver
  container.querySelectorAll(".calendar-month").forEach((el) => el.remove());

  // Create calendar for each month
  calendarData.months.forEach((month, idx) => {
    const monthCalendar = createMonthCalendar(month, idx);
    monthCalendar.dataset.monthIndex = idx;
    container.appendChild(monthCalendar);
  });

  // Clique para destacar mês e mostrar eventos
  container.querySelectorAll(".calendar-month").forEach((monthDiv, idx) => {
    monthDiv.style.display = "";
    let anyInRange = false;
    let monthEvents = [];
    monthDiv.addEventListener("click", function (e) {
      // Remove painel de total de dias do bimestre, se existir
      const infoPanel = document.getElementById("bimestreInfoPanel");
      if (infoPanel) infoPanel.remove();
      // Remove todas as classes de destaque/desfoque de todos os meses
      container.querySelectorAll(".calendar-month").forEach((el) => {
        el.classList.remove("selected");
        el.classList.remove("faded");
        // Remove legendas de eventos se houver
        const legend = el.querySelector(".month-events-legend");
        if (legend) legend.remove();
        // Remove opacidade/filtro dos dias
        el.querySelectorAll(".grid > div").forEach((dayDiv) => {
          dayDiv.style.opacity = "";
          dayDiv.style.filter = "";
        });
      });
      const isSelected = monthDiv.classList.contains("selected");
      // Se já está selecionado, desmarcar tudo
      if (isSelected) {
        return;
      }
      // Destacar mês clicado
      container.querySelectorAll(".calendar-month").forEach((el, i) => {
        el.classList.remove("selected");
        el.classList.remove("faded");
        // Remover legenda de eventos se houver
        const legend = el.querySelector(".month-events-legend");
        if (legend) legend.remove();
      });
      monthDiv.classList.add("selected");
      container.querySelectorAll(".calendar-month").forEach((el, i) => {
        if (i !== idx) el.classList.add("faded");
      });
      // Montar lista de eventos do mês (agrupando faixas)
      const monthData = calendarData.months[idx];
      const events = [];
      monthData.days.forEach((day) => {
        day.events.forEach((ev) => {
          events.push({
            date: day.date,
            text: ev.text,
            type: ev.type,
          });
        });
      });
      // Agrupar eventos iguais em faixas
      let grouped = [];
      let i = 0;
      while (i < events.length) {
        const curr = events[i];
        let j = i + 1;
        while (
          j < events.length &&
          events[j].text === curr.text &&
          events[j].type === curr.type &&
          events[j].date === events[j - 1].date + 1
        ) {
          j++;
        }
        if (j - i > 1) {
          grouped.push({
            range: [events[i].date, events[j - 1].date],
            text: curr.text,
          });
        } else {
          grouped.push({
            range: [curr.date],
            text: curr.text,
          });
        }
        i = j;
      }
      // Criar HTML da legenda interna
      let html = `<div class='month-events-legend'>`;
      if (grouped.length === 0) {
        html += "<div>Nenhum evento neste mês.</div>";
      } else {
        grouped.forEach((ev) => {
          if (ev.range.length === 1) {
            html += `<div><b>${String(ev.range[0]).padStart(2, "0")}</b> - ${
              ev.text
            }</div>`;
          } else {
            html += `<div><b>${String(ev.range[0]).padStart(2, "0")}-${String(
              ev.range[1]
            ).padStart(2, "0")}</b> - ${ev.text}</div>`;
          }
        });
      }
      html += "</div>";
      // Inserir legenda abaixo do mês selecionado
      monthDiv.insertAdjacentHTML("beforeend", html);
    });
  });

  // Fechar popup/restaurar foco
  popup.addEventListener("click", function (e) {
    if (e.target.classList.contains("close-btn")) {
      popup.classList.remove("active");
      container.querySelectorAll(".calendar-month").forEach((el) => {
        el.classList.remove("selected");
        el.classList.remove("faded");
      });
    }
  });
}

// Run when the page loads
document.addEventListener("DOMContentLoaded", initializeCalendar);

document.addEventListener("click", function (e) {
  // Se não clicou em um mês nem em um botão de bimestre
  if (
    !e.target.closest(".calendar-month") &&
    !e.target.classList.contains("bimestre-btn")
  ) {
    // Limpa seleção de bimestre
    document
      .querySelectorAll(".bimestre-btn")
      .forEach((b) => b.classList.remove("bg-blue-400", "text-white"));
    // Remove destaques/desfoques/legendas de todos os meses
    document.querySelectorAll(".calendar-month").forEach((m) => {
      m.classList.remove("selected", "faded");
      m.querySelectorAll(".grid > div").forEach((dayDiv) => {
        dayDiv.style.opacity = "";
        dayDiv.style.filter = "";
      });
      const legend = m.querySelector(".month-events-legend");
      if (legend) legend.remove();
    });
  }
});

function showBimestreTotalDias(bimestre) {
  const span = document.getElementById("bimestreTotalDias");
  if (!span) return;
  if (!bimestre) {
    // Calcular total de dias letivos do ano
    let totalLetivos = 0;
    calendarData.months.forEach((month) => {
      month.days.forEach((day) => {
        // Considera letivo se NÃO for feriado nem férias
        const isLetivo = !day.events.some(
          (ev) => ev.type === "feriado" || ev.type === "ferias"
        );
        if (isLetivo) totalLetivos++;
      });
    });
    span.textContent = `${totalLetivos} dias letivos`;
    return;
  }
  span.textContent = `${bimestreRanges[bimestre].dias} dias`;
}

function highlightBimestre(bimestre) {
  const { start, end } = bimestreRanges[bimestre];
  document.querySelectorAll(".calendar-month").forEach((monthDiv) => {
    monthDiv.style.display = "";
    let anyInRange = false;
    let monthEvents = [];
    monthDiv.querySelectorAll(".grid > div").forEach((dayDiv) => {
      const day = parseInt(dayDiv.textContent);
      const monthName = monthDiv.querySelector("h3").textContent;
      const monthIdx = [
        "Janeiro",
        "Fevereiro",
        "Março",
        "Abril",
        "Maio",
        "Junho",
        "Julho",
        "Agosto",
        "Setembro",
        "Outubro",
        "Novembro",
        "Dezembro",
      ].indexOf(monthName);
      // Ignora cabeçalhos
      if (isNaN(day)) return;
      const date = new Date(2025, monthIdx, day);
      if (date >= start && date <= end) {
        dayDiv.style.opacity = "1";
        dayDiv.style.filter = "none";
        anyInRange = true;
        // Coleta eventos do dia
        if (dayDiv.title)
          monthEvents.push(
            `${day.toString().padStart(2, "0")}/${(monthIdx + 1)
              .toString()
              .padStart(2, "0")}: ${dayDiv.title}`
          );
      } else {
        dayDiv.style.opacity = "0.3";
        dayDiv.style.filter = "blur(1.5px) grayscale(0.7)";
      }
    });
    if (anyInRange) {
      monthDiv.classList.add("selected");
      monthDiv.classList.remove("faded");
      // Adiciona eventos do mês como texto simples
      if (monthEvents.length > 0) {
        const legendDiv = document.createElement("div");
        legendDiv.className = "month-events-legend";
        legendDiv.innerHTML = monthEvents
          .map((ev) => `<div style='margin:0;padding:0;'>${ev}</div>`)
          .join("");
        monthDiv.appendChild(legendDiv);
      }
    } else {
      monthDiv.classList.add("faded");
      monthDiv.classList.remove("selected");
      // Garante que o mês continue visível (não desapareça)
      monthDiv.style.display = "";
    }
  });
  showBimestreTotalDias(bimestre);
}

document.querySelectorAll(".bimestre-btn").forEach((btn) => {
  btn.addEventListener("click", function () {
    document
      .querySelectorAll(".bimestre-btn")
      .forEach((b) => b.classList.remove("bg-blue-400", "text-white"));
    this.classList.add("bg-blue-400", "text-white");
    highlightBimestre(this.dataset.bimestre);
    // Atualiza o número de dias do bimestre no header
    const dias = bimestreRanges[this.dataset.bimestre]?.dias;
    const diasSpan = document.getElementById("bimestreTotalDias");
    if (diasSpan) {
      if (dias) {
        diasSpan.textContent = `${dias} dias`;
        diasSpan.classList.remove("hidden");
      } else {
        diasSpan.textContent = "";
        diasSpan.classList.add("hidden");
      }
    }
  });
});
// Ao clicar fora dos botões, esconder o campo de dias
const diasSpan = document.getElementById("bimestreTotalDias");
document.addEventListener("click", function (e) {
  if (!e.target.classList.contains("bimestre-btn") && diasSpan) {
    diasSpan.textContent = "";
    diasSpan.classList.add("hidden");
  }
});
